{
    "variables": {
        "client_id": "{{env `AZ_CLIENT_ID`}}",
        "client_secret": "{{env `AZ_CLIENT_SECRET`}}",
        "subscription_id": "{{env `AZ_SUBSCRIPTION_ID`}}",
        "location": "{{env `AZ_LOCATION`}}",
        "vm_size": "{{env `AZ_VM_SIZE`}}",
        "storageaccount_name": "{{env `AZ_STORAGE_ACCOUNT_NAME`}}",
        "image_resource_group": "{{env `AZ_IMAGE_RESOURCE_GROUP`}}",
        "image_version": "{{env `IMAGE_VERSION`}}",
        "image_name": "{{env `IMAGE_NAME`}}",
        "image_alias": "{{env `IMAGE_ALIAS`}}",
        "image_publisher": "{{env `IMAGE_PUBLISHER`}}",
        "image_offer": "{{env `IMAGE_OFFER`}}",
        "image_sku": "{{env `IMAGE_SKU`}}",
        "build_number": "{{env `BUILD_NUMBER`}}",
        "definition_name": "{{env `DEFINITION_NAME`}}",
        "definition_version": "{{env `DEFINITION_VERSION`}}",
        "repository_name": "{{env `REPOSITORY_NAME`}}",
        "source_branch": "{{env `SOURCE_BRANCH`}}",
        "source_version": "{{env `SOURCE_VERSION`}}",
        "jre_location":"C:\\"
    },
    "builders": [
        {
            "type": "azure-arm",
            "subscription_id": "{{user `subscription_id`}}",
            "client_id": "{{user `client_id`}}",
            "client_secret": "{{user `client_secret`}}",
            "managed_image_resource_group_name": "{{user `image_resource_group`}}",
            "managed_image_name": "{{user `image_name`}}",
            "os_type": "Windows",
            "image_publisher": "{{user `image_publisher`}}",
            "image_offer": "{{user `image_offer`}}",
            "image_sku": "{{user `image_sku`}}",
            "async_resourcegroup_delete": "true",
            "communicator": "winrm",
            "winrm_use_ssl": "true",
            "winrm_insecure": "true",
            "winrm_timeout": "4h",
            "winrm_username": "packer",
            "location": "{{user `location`}}",
            "vm_size": "{{user `vm_size`}}",
            "managed_image_storage_account_type": "Premium_LRS",
            "azure_tags": {
                "Owner": "devops@uipath.com",
                "Project": "DevOps",
                "buildNumber": "{{user `build_number`}}",
                "definitionName": "{{user `definition_name`}}",
                "definitionVersion": "{{user `definition_version`}}",
                "repositoryName": "{{user `repository_name`}}",
                "sourceBranch": "{{user `source_branch`}}",
                "sourceVersion": "{{user `source_version`}}",
                "imageVersion": "{{user `image_version`}}",
                "imageAlias": "{{user `image_alias`}}"
              }
        }
    ],
    "provisioners": [
        {
            "type": "powershell",
            "scripts": [
                "{{template_dir}}/scripts/SetupWinRM.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts": [
                "{{template_dir}}/scripts/SetupAnsibleInventory.ps1"
            ],
            "environment_vars": [
                "ARTIFACT_SERVER={{user `artifact_server`}}",
                "PACKER_WINRMINSEC=True",
                "PACKER_PASSWORD={{.WinRMPassword}}",
                "PACKER_USESSL=True"
            ]
        },
        {
            "type": "file",
            "source": "inventory.txt",
            "destination": "inventory.txt",
            "direction": "download"
        },
        {
            "type": "shell-local",
            "environment_vars": [
                "IMAGE_NAME={{user `image_name`}}",
                "IMAGE_ALIAS={{user `image_alias`}}",
                "AZ_STORAGE_ACCOUNT_NAME={{user `storageaccount_name`}}"
            ],
            "command": "ansible-playbook playbooks/playbook.yml -i inventory.txt -e disable_reboot=True -vv"
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [ 
                "Write-Output \"starting sysprep\"" ,
                "if( Test-Path $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml -Force }" ,
                "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
                "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
            ],
			"only":["azure-arm"]
        }
    ]
}
